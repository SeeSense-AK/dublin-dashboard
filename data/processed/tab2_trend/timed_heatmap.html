<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Temporal Heatmap</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.0/dist/leaflet.timedimension.control.min.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.0/dist/leaflet.timedimension.min.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
  html, body { margin: 0; padding: 0; height: 100%; }
  #map { height: 100vh; width: 100%; }
  .leaflet-control-timecontrol { z-index: 1000; }
</style>
</head>
<body>
<div id="map"></div>
<script>
var map = L.map('map', {
  zoom: 12,
  center: [53.34, -6.26],
  timeDimension: true,
  timeDimensionControl: true,
  timeDimensionControlOptions: {
    speedSlider: true,
    loopButton: true,
    autoPlay: true,
    playerOptions: { transitionTime: 1000, loop: true }
  }
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

fetch("route_popularity_timeseries.geojson")
  .then(r => r.json())
  .then(data => {
    function getHeatData(layerData) {
      return layerData.features.map(f => [
        f.geometry.coordinates[1],
        f.geometry.coordinates[0],
        f.properties.popularity / 10
      ]);
    }

    var heatLayer = L.heatLayer([], { radius: 25, blur: 15, maxZoom: 14, minOpacity: 0.4 });

    var timedGeoJSON = L.timeDimension.layer.geoJson(L.geoJson(data), {
      updateTimeDimension: true,
      addlastPoint: false,
      waitForReady: true
    });

    timedGeoJSON.on('timeload', function(e) {
      var frameData = e.target._baseLayer.toGeoJSON();
      var heatData = getHeatData(frameData);
      heatLayer.setLatLngs(heatData);
    });

    timedGeoJSON.addTo(map);
    heatLayer.addTo(map);
  });
</script>
</body>
</html>
